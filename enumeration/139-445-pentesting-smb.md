# 139,445 - Pentesting SMB

## Cheatsheets for SMB

### Nmap

```bash
#What is the workgroup name of samba server?
nmap -sV -p 445 192.126.66.3
#Find the exact version of samba server by using appropriate nmap script.
nmap --script smb-os-discovery.nse -p 445 192.126.66.3
#Check for ms17 vulns
nmap --script smb-vuln-ms17-010 -p139,445 10.1.100.11
#Find the default udp ports used by nmbd.
nmap -sU --top-ports 25 192.126.66.3
```

#### Nmap Script

```bash
# We will run the Nmap script to list the supported protocols and dialects of an SMB server.
nmap -p445 --script smb-protocols $ip
# Running security mode script to return the information about the SMB security level.
nmap -p445 --script smb-security-mode $ip
# Enumerating the users logged into a system through an SMB share with Nmap script.
nmap -p445 --script smb-enum-sessions $ip
# We have the SMB server credentials, We will use it with Nmap script to scan the target to discover sensitive information.
nmap -p445 --script smb-enum-sessions --script-args smbusername=administrator,smbpassword=smbserver_771 $ip
# Enumerating all available shares
nmap -p445 --script smb-enum-shares $ip
# Scanning all shares using valid credentials to check the permissions.
nmap -p445 --script smb-enum-shares --script-args
smbusername=administrator,smbpassword=smbserver_771 $ip
# Enumerate the windows users on a target machine.
nmap -p445 --script smb-enum-users --script-args
smbusername=administrator,smbpassword=smbserver_771 $ip
# Get information about the server statistics. It uses port 445 and port 139 to fetch the details.
nmap -p445 --script smb-server-stats --script-args
smbusername=administrator,smbpassword=smbserver_771 $ip
# Enumerating available domains on a target machine
nmap -p445 --script smb-enum-domains --script-args
smbusername=administrator,smbpassword=smbserver_771 $ip
# Enumerating available user groups on a target machine.
nmap -p445 --script smb-enum-groups --script-args
smbusername=administrator,smbpassword=smbserver_771 $ip
# Enumerating services on a target machine
nmap -p445 --script smb-enum-services --script-args
smbusername=administrator,smbpassword=smbserver_771 $ip
# Enumerating all the shared folders and drives then running the ls command
nmap -p445 --script smb-enum-shares,smb-ls --script-args
smbusername=administrator,smbpassword=smbserver_771 $ip
```

### NetBIOS

```bash
#Find the NetBIOS computer name of samba server using nmblookup
nmblookup -A 192.126.66.3
```

### smbclient

```bash
#Using smbclient determine whether anonymous connection (null session) is allowed on the samba server or not & list all available shares on the samba server using smbclient.
smbclient -L 192.126.66.3 -N
```

### rpcclient

```bash
#Using rpcclient determine whether anonymous connection (null session) is allowed on the samba server or not.
rpcclient -U "" -N 192.126.66.3
#Find the OS version of samba server using rpcclient
srvinfo
#List all users that exists on the samba server
enumdomusers
#SID of user "admin" using rpcclient
lookupnames admin
#Find domain groups that exists on the samba server by using rpcclient.
enumdomgroups
```

### enum4linux

```bash
#Find the OS version of samba server using enum4Linux.
enum4linux -o 192.144.106.3
#List all users that exists on the samba server using enum4Linux.
enum4linux -U 192.144.106.3
#List all available shares on the samba server using enum4Linux.
enum4linux -S 192.144.106.3
#Find domain groups that exists on the samba server by using enum4Linux.
enum4linux -G 192.144.106.3
#Is samba server configured for printing?.
enum4linux -i 192.144.106.3
#-r enumerate users via RID cycling
enum4linux -r -u "admin" -p "password1" 192.212.251.3
```

### SMBMap

```bash
#Running smbmap tool to discover all shared folders and drives.
smbmap -u guest -p "" -d . -H 10.0.28.123
#Running smbmap with administrator user credentials.
smbmap -u administrator -p smbserver_771 -d . -H 10.0.28.123
#Execute the command on the target machine through SMB.
smbmap -H 10.0.28.123 -u administrator -p smbserver_771 -x 'ipconfig'
#Listing all drives on the specified host
smbmap -H 10.0.28.123 -u Administrator -p 'smbserver_771' -L
#(Windows) List contents of the directory of C:\ drive. 
smbmap -H 10.0.28.123 -u Administrator -p 'smbserver_771' -r 'C$'
#Uploading a sample file
touch backdoor
smbmap -H 10.0.28.123 -u Administrator -p 'smbserver_771' --upload '/root/backdoor' 'C$\backdoor'
#Download file using smbmap
smbmap -H 10.0.28.123 -u Administrator -p 'smbserver_771' --download
'C$\flag.txt'
```

### Hydra

```bash
#Use hydra with password wordlist
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.212.251.3 smb
```

#### psexec.py

```bash
psexec.py administrator@192.168.1.1
```
